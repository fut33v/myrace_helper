# codex_context.md

## Проект
MyRace Helper

## Описание
Набор скриптов и сервисов, автоматизирующих работу с платформой MyRace: авторизация через cookies, массовое создание промокодов и управление процессом из Telegram-бота. Решение избавляет организаторов от ручного заполнения web-форм и ускоряет выпуск промокодов для выбранных гонок.

## Стек технологий
- Python 3.11
- requests, httpx
- BeautifulSoup4
- Selenium (Chromium/Firefox через Selenium Manager)
- python-telegram-bot (asyncio)
- Docker + Chromium (headless)
- Bash-скрипты для обёрток запуска

## Цель проекта
- Автоматически авторизоваться на MyRace без ввода пароля (используя экспортированные cookies).
- Создавать промокоды для выбранных гонок с заданными параметрами (скидка, лимит, слот).
- Управлять созданием промокодов и списком гонок из Telegram-бота, ограничивая доступ администраторам.
- Поддерживать воспроизводимую среду запуска локально и в Docker.

## Основные модули / компоненты
- `myrace_login.py` — парсинг HTML-форм MyRace, вспомогательные утилиты для логина и работы с cookies.
- `myrace_selenium.py` — сборка Selenium-драйверов, управление cookies и заполнением форм.
- `create_promo_codes.py` — CLI для пакетного создания промокодов, использующий Selenium-утилиты.
- `telegram_bot.py` — Telegram-бот (python-telegram-bot) с командами `/promo`, `/promo100`, `/setcookies`, `/races`, `/setrace`, `/addrace`.
- `convert_cookies.py` — конвертация браузерных cookies в формат Netscape.
- Запуск: `run_bot.sh`, `run_bot_local.sh`, `docker-entrypoint.sh`, `Dockerfile`.
- Конфигурация: `.env`, `requirements.txt`, `cookies/myrace_cookies.txt`, `races.json` (генерируется ботом).

## Ключевые структуры данных
- `FormField` / `FormInfo` (`myrace_login.py`) — описание HTML-формы (имена полей, значения, обязательность, варианты выбора) для дальнейшего автозаполнения.
- `TYPE_SLUGS` (`create_promo_codes.py`) — карта читаемых названий типов промокодов к slug’ам, управляющим маршрутом (например, `distance`).
- Netscape-cookie файл (`cookies/myrace_cookies.txt`) — источник авторизации и общий контракт между CLI/ботом и Selenium.
- Список гонок (`races.json`) — вручную/автоматически собранные пары `<id, title>` для выбора гонки ботом.

## Архитектура
- CLI-утилиты (login, создание промокодов) + Telegram-бот.
- Поток данных при создании промокода: пользователь → команда боту → валидация доступа → запуск `create_promo_codes.py` → Selenium открывает MyRace с cookies → форма промокода → возврат статуса и фактического кода в Telegram.
- Авторизация основана только на cookies; логин/пароль и почтовые ссылки исключены из текущего контура.
- Docker-окружение предоставляет воспроизводимую среду (Chromium, зависимости, bot entrypoint).

## Стиль кода и конвенции
- PEP 8, `camelCase` только для телеграм-команд/внешних API; в Python — `snake_case`.
- Максимально используем типизацию (`from __future__ import annotations`, `typing`).
- Логирование через стандартный `logging`, сообщения на русском.
- Комментарии пунктирные и только для нетривиальных мест.
- Конфигурация через переменные окружения и .env (без хардкода секретов).
- Всегда работаем с cookies в формате Netscape, а не с логином/паролем.

## Текущие задачи
- Мониторинг стабильности парсинга списка гонок (fallback к событию `/events/<id>` при placeholder-титуле).
- Улучшение обработки ошибок Selenium при смене структуры форм промокода.
- Тестирование и отладка работы Telegram-бота в Docker и на bare-metal окружениях.
- Автоматическое продление/обновление cookies и уведомления об их истечении.

## Инструкция для Codex
- Этот файл служит постоянным контекстом и должен учитываться перед изменением кода.
- Всегда соотносите новые правки с текущей архитектурой и стилем.
- Перед модификациями анализируйте влияние на CLI, бота и Docker-окружение.
- Придерживайтесь описанного стекa, соглашений по стилю и текущих задач.
- Не переходите на логин по паролю; работайте только с cookies и их обновлением.
- Документируйте нетривиальные изменения (README, логирование) и сохраняйте русскоязычные сообщения.
